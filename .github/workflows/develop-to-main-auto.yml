name: Auto Create PR from Develop to Main

on:
  pull_request:
    types: [closed]
    branches: [develop]

jobs:
  create-develop-to-main-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: develop

      - name: Create PR from Develop to Main
        uses: actions/github-script@v6
        with:
          script: |
            // Verificar se jÃ¡ existe um PR de develop para main
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'develop',
              base: 'main'
            });
            
            if (existingPRs.length === 0) {
              // Obter informaÃ§Ãµes do Ãºltimo commit em develop
              const { data: developCommits } = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: 'develop',
                per_page: 1
              });
              
              const lastCommit = developCommits[0];
              const mergedPR = context.payload.pull_request;
              
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš€ Release: Develop to Main - ${new Date().toISOString().split('T')[0]}`,
                body: `## ğŸš€ Release AutomÃ¡tico: Develop â†’ Main

### ğŸ“‹ Resumo
Pull Request automÃ¡tico criado apÃ³s merge de feature para develop.

### ğŸ”„ Detalhes do Merge Anterior
- **PR Original**: #${mergedPR.number} - ${mergedPR.title}
- **Branch Origem**: ${mergedPR.head.ref}
- **Autor**: ${mergedPR.user.login}
- **Data do Merge**: ${new Date(mergedPR.merged_at).toLocaleString('pt-BR')}

### ğŸ“Š Commits IncluÃ­dos
- **Ãšltimo Commit**: ${lastCommit.sha.substring(0, 7)}
- **Mensagem**: ${lastCommit.commit.message}
- **Autor**: ${lastCommit.commit.author.name}

### âœ… Checklist de Release
- [ ] âœ… CÃ³digo revisado e aprovado
- [ ] âœ… Testes passando em develop
- [ ] âœ… DocumentaÃ§Ã£o atualizada
- [ ] âœ… Sem conflitos de merge
- [ ] âœ… Build de produÃ§Ã£o bem-sucedido

### ğŸ·ï¸ Labels Aplicadas
- `release`
- `automated`
- `develop-to-main`

### ğŸ“ Notas
- Este PR foi criado automaticamente pelo GitHub Actions
- Merge automÃ¡tico habilitado apÃ³s aprovaÃ§Ã£o
- Release para produÃ§Ã£o

---
*PR criado automaticamente apÃ³s merge de feature para develop*`,
                head: 'develop',
                base: 'main'
              });
              
              // Adicionar labels
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['release', 'automated', 'develop-to-main']
              });
              
              // Adicionar reviewers (opcional - descomente se necessÃ¡rio)
              // await github.rest.pulls.requestReviewers({
              //   owner: context.repo.owner,
              //   repo: context.repo.repo,
              //   pull_number: pr.data.number,
              //   reviewers: ['seu-usuario-aqui']
              // });
              
              console.log(`ğŸš€ Release PR #${pr.data.number} criado com sucesso!`);
              console.log(`ğŸ“Š PR Original: #${mergedPR.number} - ${mergedPR.title}`);
            } else {
              console.log('âš ï¸ PR de develop para main jÃ¡ existe');
              console.log(`ğŸ“‹ PR existente: #${existingPRs[0].number}`);
            } 